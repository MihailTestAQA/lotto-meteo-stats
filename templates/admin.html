{% extends "base.html" %}

{% block title %}Управление - LottoMeteoStats{% endblock %}

{% block content %}
<div class="admin-container">
    <h2><i class="fas fa-cog"></i> Панель управления</h2>
    
    <div class="admin-cards">
        <div class="admin-card">
            <h3><i class="fas fa-database"></i> База данных</h3>
            <p>Статус: <span id="dbStatus" class="status-active">Проверка...</span></p>
            <p>Записей: <span id="dbRecords">{{ total_records if total_records else 0 }}</span></p>
            <p>Файл: <small id="dbFile">lottery.db</small></p>
            <div class="admin-actions">
                <button onclick="refreshDatabase()" class="btn btn-sm btn-warning">
                    <i class="fas fa-redo"></i> Обновить БД
                </button>
                <button onclick="checkDatabase()" class="btn btn-sm btn-info">
                    <i class="fas fa-search"></i> Проверить
        </button>
    </div>
</div>
        
        <div class="admin-card">
            <h3><i class="fas fa-sync-alt"></i> Сбор данных</h3>
            <p>Последнее обновление: <span id="lastUpdate">Неизвестно</span></p>
            <div class="admin-actions">
                <button onclick="runParser(event)" id="runParserBtn" class="btn btn-sm btn-primary">
                    <i class="fas fa-play"></i> Запустить парсер
                </button>
            </div>
        </div>
        
        <div class="admin-section">
            <h2><i class="fas fa-chart-line"></i> Статистика Felix Pila</h2>
            <p>Продвинутый анализ связи погоды и чисел</p>
    
            <div class="stats-mini">
                <p><i class="fas fa-ticket-alt"></i> Лотерея: <span id="lotteryCount">0</span> тиражей</p>
                <p><i class="fas fa-cloud"></i> Погода: <span id="weatherCount">0</span> записей</p>
            </div>
    <a href="/felix-pila" class="admin-btn">
        <i class="fas fa-magic"></i> Перейти к Felix Pila
    </a>
</div>
    </div>
    
    <div class="admin-logs">
        <h3><i class="fas fa-clipboard-list"></i> Логи</h3>
        <div id="logsContainer" class="logs-container">
            <div class="log-entry">Система запущена...</div>
        </div>
    </div>
</div>

<style>
.admin-container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
.admin-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 2rem 0; }
.admin-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.admin-actions { margin-top: 1rem; display: flex; gap: 10px; }
.status-error {
    color: #e74c3c;
    font-weight: bold;
    background: #ffebee;
    padding: 2px 8px;
    border-radius: 4px;
}
.status-warning {
    color: #f3ef12;
    font-weight: bold;
    background: #fff3cd;
    padding: 2px 8px;
    border-radius: 4px;
}
.stats-mini {
    background: rgba(255,255,255,0.1);
    padding: 10px;
    border-radius: 5px;
    margin: 15px 0;
    font-size: 0.9em;
}
.stats-mini p {
    margin: 5px 0;
}
.btn-warning {
    background: #ebef05;
    color: white;
    border: none;
}

.btn-warning:hover {
    background: #e6e322;
}

.btn-sm {
    padding: 5px 10px;
    font-size: 0.85rem;
}
.status-active { color: #27ae60; font-weight: bold; }
.logs-container { background: #f8f9fa; padding: 1rem; border-radius: 8px; max-height: 300px; overflow-y: auto; }
.log-entry { padding: 0.5rem; border-bottom: 1px solid #eee; font-family: monospace; font-size: 0.9rem; }
</style>

<script>
async function runParser() {
    // Меняем текст кнопки на "Запускаю..."
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Запуск...';
    button.disabled = true;

    try {
        // ✅ Ключевое изменение: отправляем запрос на ПРАВИЛЬНЫЙ эндпоинт
        const response = await fetch('/api/run-parser', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });

    // ✅ ДОБАВЬ ЭТУ ПРОВЕРКУ
        if (!response.ok) {
            throw new Error(`Ошибка сервера: ${response.status}`);
}

        const result = await response.json();
        
        if (result.success) {
            alert(`✅Парсер запущен... ${result.message}`);
            // Обновляем время последнего обновления
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
            
            // (Опционально) Автоматически обновляем таблицу с данными через 2 секунды
            setTimeout(() => {
                if (typeof loadLotteryData === 'function') {
                    loadLotteryData();
                }
            }, 2000);
        } else {
            alert(`❌ Ошибка: ${result.message || 'Неизвестная ошибка'}`);
        }
    } catch (error) {
        console.error('Ошибка при запуске парсера:', error);
        alert('❌ Ошибка соединения с сервером');
    } finally {
        // Восстанавливаем кнопку
        button.innerHTML = originalText;
        button.disabled = false;
    }
}
// Функция обновления данных БД
async function refreshDatabase() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Обновление...';
    button.disabled = true;
    
    try {
        // Запрашиваем данные через API
        const response = await fetch('/api/lottery/data');
        
        if (!response.ok) {
            throw new Error(`HTTP ошибка: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('dbRecords').textContent = result.total;
            document.getElementById('dbStatus').textContent = 'Активна';
            document.getElementById('dbStatus').className = 'status-active';
            
            // Обновляем также в карточке статистики
            document.getElementById('lotteryCount').textContent = result.total;
            
            console.log(`✅ Данные БД обновлены. Записей: ${result.total}`);
        } else {
            document.getElementById('dbStatus').textContent = 'Ошибка';
            document.getElementById('dbStatus').className = 'status-error';
            alert(`❌ ${result.message}`);
        }
        
    } catch (error) {
        console.error('Ошибка обновления БД:', error);
        document.getElementById('dbStatus').textContent = 'Ошибка подключения';
        document.getElementById('dbStatus').className = 'status-error';
        alert('❌ Ошибка подключения к БД');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Функция проверки состояния БД
async function checkDatabase() {
    try {
        const response = await fetch('/api/health');
        
        if (!response.ok) {
            throw new Error(`HTTP ошибка: ${response.status}`);
        }
        
        const result = await response.json();
        
        // Обновляем статус
        const statusEl = document.getElementById('dbStatus');
        if (result.status === 'healthy') {
            statusEl.textContent = `Активна (${result.records} записей)`;
            statusEl.className = 'status-active';
            document.getElementById('dbRecords').textContent = result.records;
        } else {
            statusEl.textContent = 'Проблемы с БД';
            statusEl.className = 'status-error';
        }
        
    } catch (error) {
        console.error('Ошибка проверки БД:', error);
        document.getElementById('dbStatus').textContent = 'Ошибка проверки';
        document.getElementById('dbStatus').className = 'status-error';
        alert('❌ Ошибка проверки БД');
    }
}

// Автоматическая загрузка данных при открытии страницы
document.addEventListener('DOMContentLoaded', () => {
    // Проверяем БД сразу при загрузке
    checkDatabase();
    
    // Загружаем статистику лотереи
    fetch('/api/lottery/data')
        .then(r => r.json())
        .then(data => {
            if(data.success) {
                document.getElementById('lotteryCount').textContent = data.total || 0;
                document.getElementById('dbRecords').textContent = data.total || 0;
                document.getElementById('lastUpdate').textContent = 
                    new Date(data.last_update).toLocaleString('ru-RU');
            }
        });
});
</script>

// Загружаем статистику при загрузке
document.addEventListener('DOMContentLoaded', () => {
    fetch('/api/lottery/data')
        .then(r => r.json())
        .then(data => {
            if(data.success) {
                document.getElementById('lotteryCount').textContent = data.total || 0;
                document.getElementById('lastUpdate').textContent = 
                    new Date(data.last_update).toLocaleString('ru-RU');
            }
        });
});
</script>
{% endblock %}