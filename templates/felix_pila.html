{% extends "base.html" %}

{% block title %}Felix Pila - LottoMeteoStats{% endblock %}

{% block content %}
<style>
    /* –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò –°–¢–†–ê–ù–ò–¶–´ */
    .felix-page {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    /* –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† */
    .felix-grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 30px;
        margin-bottom: 40px;
    }

    .felix-card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        height: fit-content;
    }

    .felix-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
    }

    .felix-card h2 {
        color: #4a5568;
        margin-bottom: 25px;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 12px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f1f5f9;
    }

    /* –ü–†–û–ì–ù–û–ó –ß–ò–°–ï–õ - –ù–û–í–ê–Ø –°–ï–¢–ö–ê */
    .prediction-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin: 20px 0;
    }

    .field-container {
        background: #f8fafc;
        border-radius: 15px;
        padding: 20px;
        border: 2px solid #e2e8f0;
    }

    .field-title {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        color: #4a5568;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .field-numbers {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }

    .field-1 .felix-number-item {
        background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
    }

    .field-2 .felix-number-item {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    }

    .felix-number-item {
        border-radius: 15px;
        padding: 20px 10px;
        text-align: center;
        position: relative;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .felix-number-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .felix-number-value {
        font-size: 2rem;
        font-weight: bold;
        color: white;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .felix-number-prob {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.9);
        margin-top: 5px;
        font-weight: 500;
    }

    .felix-number-rank {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        width: 25px;
        height: 25px;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
    }

    /* –§–ò–õ–¨–¢–†–´ */
    .felix-filters-section {
        background: white;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    }

    .felix-filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 25px;
    }

    .felix-filter-group {
        margin-bottom: 10px;
    }

    .felix-filter-group label {
        display: block;
        margin-bottom: 8px;
        color: #4a5568;
        font-weight: 500;
        font-size: 0.95rem;
    }

    .felix-filter-control {
        width: 100%;
        padding: 12px 15px;
        border-radius: 10px;
        border: 2px solid #e2e8f0;
        background: #f8fafc;
        color: #4a5568;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .felix-filter-control:focus {
        outline: none;
        border-color: #f39c12;
        background: white;
        box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
    }

    .felix-filter-actions {
        display: flex;
        gap: 15px;
        align-items: flex-end;
    }

    .felix-filter-btn {
        padding: 12px 25px;
        border-radius: 10px;
        border: none;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }

    .felix-filter-btn.primary {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        color: white;
    }

    .felix-filter-btn.secondary {
        background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
        color: white;
    }

    .felix-filter-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    /* –ò–ù–°–ê–ô–¢–´ */
    .insights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .insight-card {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        padding: 25px;
        border-radius: 15px;
        border-left: 5px solid #f39c12;
        transition: all 0.3s ease;
    }

    .insight-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .insight-card i {
        font-size: 2rem;
        color: #f39c12;
        margin-bottom: 15px;
    }

    .insight-card h3 {
        color: #4a5568;
        margin-bottom: 15px;
        font-size: 1.2rem;
    }

    .insight-numbers {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 15px;
    }

    .insight-number-badge {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1rem;
    }

    /* –ì–†–ê–§–ò–ö */
    .chart-wrapper {
        background: #f8fafc;
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
        border: 1px solid #e2e8f0;
    }

    .chart-container {
        height: 300px;
        position: relative;
    }

    /* –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–´–ï –ë–ê–î–ñ–ò */
    .felix-info-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: rgba(243, 156, 18, 0.1);
        color: #f39c12;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        margin-top: 15px;
    }

    /* –ò–ù–î–ò–ö–ê–¢–û–†–´ –î–ê–ù–ù–´–• - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –¶–í–ï–¢–ê */
    .data-indicators {
        display: flex;
        gap: 15px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .data-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 15px;
        border-radius: 10px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .data-indicator.real {
        background: rgba(46, 204, 113, 0.1);
        color: #27ae60;
        border: 1px solid rgba(46, 204, 113, 0.3);
    }

    .data-indicator.demo {
        background: rgba(241, 196, 15, 0.1);
        color: #f39c12;
        border: 1px solid rgba(241, 196, 15, 0.3);
    }

    .data-indicator.api {
        background: rgba(155, 89, 182, 0.1); /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –¥–ª—è API */
        color: #8e44ad;
        border: 1px solid rgba(155, 89, 182, 0.3);
    }

    .data-indicator.active {
        background: rgba(46, 204, 113, 0.2); /* –ó–µ–ª–µ–Ω—ã–π –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö */
        color: #27ae60;
        border: 2px solid #27ae60;
        font-weight: 600;
    }

    .data-indicator i {
        font-size: 1rem;
    }

    /* –°–¢–ê–¢–£–° –ë–ê–† */
    .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 15px;
        margin-bottom: 20px;
        border: 1px solid #e2e8f0;
    }

    .status-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    .status-dot.real {
        background: #2ecc71;
        box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
    }

    .status-dot.demo {
        background: #f39c12;
        box-shadow: 0 0 10px rgba(243, 156, 18, 0.5);
    }

    .status-text {
        font-size: 0.9rem;
        font-weight: 500;
        color: #4a5568;
    }

    /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
    @media (max-width: 768px) {
        .felix-page {
            padding: 15px;
        }

        .felix-grid-container {
            grid-template-columns: 1fr;
        }

        .felix-card {
            padding: 20px;
        }

        .prediction-grid {
            grid-template-columns: 1fr;
        }

        .field-numbers {
            grid-template-columns: repeat(4, 1fr);
        }

        .felix-filters-grid {
            grid-template-columns: 1fr;
        }

        .felix-filter-actions {
            flex-direction: column;
        }

        .status-bar {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }
    }

    @media (max-width: 480px) {
        .field-numbers {
            grid-template-columns: repeat(2, 1fr);
        }

        .felix-number-value {
            font-size: 1.5rem;
        }
    }

    /* –ê–ù–ò–ú–ê–¶–ò–ò */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .felix-card {
        animation: fadeInUp 0.5s ease-out;
    }

    .felix-card:nth-child(1) { animation-delay: 0.1s; }
    .felix-card:nth-child(2) { animation-delay: 0.2s; }
    .felix-card:nth-child(3) { animation-delay: 0.3s; }

    /* –ó–ê–ì–†–£–ó–ö–ê */
    .loading-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #718096;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f1f5f9;
        border-top: 3px solid #f39c12;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<div class="felix-page">
    <!-- –°–¢–ê–¢–£–° –ë–ê–† -->
    <div class="status-bar">
        <div class="status-item">
            <div class="status-dot" id="dataSourceDot"></div>
            <span class="status-text" id="dataSourceText">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span>
        </div>
        <div class="status-item">
            <div class="status-dot" id="accuracyDot"></div>
            <span class="status-text" id="accuracyText">–¢–æ—á–Ω–æ—Å—Ç—å: –∑–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <button onclick="refreshAllData()" class="felix-filter-btn primary" style="padding: 8px 15px; font-size: 0.9rem;">
            <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ
        </button>
    </div>

    <!-- –§–ò–õ–¨–¢–†–´ -->
    <div class="felix-filters-section">
        <h3><i class="fas fa-filter"></i> –§–∏–ª—å—Ç—Ä—ã –∞–Ω–∞–ª–∏–∑–∞ Felix Pila</h3>
        <div class="felix-filters-grid">
            <div class="felix-filter-group">
                <label>–¢–∏–ø –ø–æ–≥–æ–¥—ã:</label>
                <select id="weatherFilter" class="felix-filter-control">
                    <option value="">–í—Å–µ –ø–æ–≥–æ–¥—ã</option>
                    <option value="—è—Å–Ω–æ">–Ø—Å–Ω–æ</option>
                    <option value="–ø–∞—Å–º—É—Ä–Ω–æ">–ü–∞—Å–º—É—Ä–Ω–æ</option>
                    <option value="–¥–æ–∂–¥—å">–î–æ–∂–¥—å</option>
                    <option value="—Å–Ω–µ–≥">–°–Ω–µ–≥</option>
                    <option value="—Ç—É–º–∞–Ω">–¢—É–º–∞–Ω</option>
                </select>
            </div>
            
            <div class="felix-filter-group">
                <label>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ä–µ–∂–∏–º:</label>
                <select id="tempFilter" class="felix-filter-control">
                    <option value="">–í—Å–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã</option>
                    <option value="cold">–•–æ–ª–æ–¥–Ω–æ (< 0¬∞C)</option>
                    <option value="cool">–ü—Ä–æ—Ö–ª–∞–¥–Ω–æ (0-15¬∞C)</option>
                    <option value="warm">–¢–µ–ø–ª–æ (16-25¬∞C)</option>
                    <option value="hot">–ñ–∞—Ä–∫–æ (> 25¬∞C)</option>
                </select>
            </div>
            
            <div class="felix-filter-actions">
                <button onclick="loadAnalysis()" class="felix-filter-btn primary">
                    <i class="fas fa-sync-alt"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑
                </button>
                <button onclick="resetFelixFilters()" class="felix-filter-btn secondary">
                    <i class="fas fa-redo"></i> –°–±—Ä–æ—Å–∏—Ç—å
                </button>
            </div>
        </div>
        
        <!-- –ò–ù–î–ò–ö–ê–¢–û–†–´ –î–ê–ù–ù–´–• - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –¶–í–ï–¢–ê -->
        <div class="data-indicators">
            <div class="data-indicator api" id="dbIndicator">
                <i class="fas fa-database"></i>
                <span>–ë–î: –ø—Ä–æ–≤–µ—Ä–∫–∞...</span>
            </div>
            <div class="data-indicator api" id="apiIndicator">
                <i class="fas fa-server"></i>
                <span>API: –ø—Ä–æ–≤–µ—Ä–∫–∞...</span>
            </div>
            <div class="data-indicator demo" id="demoIndicator">
                <i class="fas fa-vial"></i>
                <span>–î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ</span>
            </div>
        </div>
    </div>

    <!-- –û–°–ù–û–í–ù–´–ï –ö–ê–†–¢–û–ß–ö–ò -->
    <div class="felix-grid-container">
        <!-- –ü–†–û–ì–ù–û–ó –ù–ê –û–°–ù–û–í–ï –ü–û–ì–û–î–´ - –ù–û–í–´–ô –î–ò–ó–ê–ô–ù -->
        <div class="felix-card">
            <h2><i class="fas fa-crystal-ball"></i> –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
            <p style="color: #718096; margin-bottom: 15px;">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —á–∏—Å–ª–∞ –ø–æ –ø–æ–ª—è–º –ª–æ—Ç–µ—Ä–µ–∏:</p>
            
            <div id="weatherPrediction" class="prediction-grid">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞...</p>
                </div>
            </div>
            
            <div class="felix-info-badge">
                <i class="fas fa-chart-line"></i>
                –¢–æ—á–Ω–æ—Å—Ç—å –ø—Ä–æ–≥–Ω–æ–∑–∞: <span id="accuracyScore">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </div>

        <!-- –ì–†–ê–§–ò–ö –ê–ù–ê–õ–ò–ó–ê -->
        <div class="felix-card">
            <h2><i class="fas fa-chart-network"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–≤—è–∑–µ–π</h2>
            <div class="chart-wrapper">
                <div class="chart-container">
                    <canvas id="analysisChart"></canvas>
                </div>
            </div>
            <div class="felix-info-badge">
                <i class="fas fa-project-diagram"></i>
                –ê–Ω–∞–ª–∏–∑ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –ø–æ–≥–æ–¥–∞-—á–∏—Å–ª–∞
            </div>
        </div>

        <!-- –ò–ù–°–ê–ô–¢–´ -->
        <div class="felix-card" style="grid-column: span 2;">
            <h2><i class="fas fa-lightbulb"></i> –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã</h2>
            <div class="insights-grid">
                <div class="insight-card">
                    <i class="fas fa-sun"></i>
                    <h3>–í —è—Å–Ω—É—é –ø–æ–≥–æ–¥—É —á–∞—â–µ –≤—ã–ø–∞–¥–∞—é—Ç:</h3>
                    <div id="sunnyNumbers" class="insight-numbers">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <div class="insight-card">
                    <i class="fas fa-cloud-rain"></i>
                    <h3>–í –¥–æ–∂–¥–ª–∏–≤—É—é –ø–æ–≥–æ–¥—É —á–∞—â–µ –≤—ã–ø–∞–¥–∞—é—Ç:</h3>
                    <div id="rainyNumbers" class="insight-numbers">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <div class="insight-card">
                    <i class="fas fa-temperature-low"></i>
                    <h3>–ü—Ä–∏ –Ω–∏–∑–∫–æ–º –¥–∞–≤–ª–µ–Ω–∏–∏ —á–∞—â–µ –≤—ã–ø–∞–¥–∞—é—Ç:</h3>
                    <div id="lowPressureNumbers" class="insight-numbers">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <div class="insight-card">
                    <i class="fas fa-temperature-high"></i>
                    <h3>–í —Ç–µ–ø–ª—É—é –ø–æ–≥–æ–¥—É —á–∞—â–µ –≤—ã–ø–∞–¥–∞—é—Ç:</h3>
                    <div id="warmNumbers" class="insight-numbers">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// === –†–ê–ë–û–ß–ò–ô JavaScript –ö–û–î ===

let dataSource = 'demo'; // 'real', 'demo', 'mixed'

// 1. –ü–†–û–í–ï–†–ö–ê –ò–°–¢–û–ß–ù–ò–ö–û–í –î–ê–ù–ù–´–•
async function checkDataSources() {
    console.log("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö...");
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î
    try {
        const dbResponse = await fetch('/api/health');
        if (dbResponse.ok) {
            const dbData = await dbResponse.json();
            const dbIndicator = document.getElementById('dbIndicator');
            
            if (dbData.records && dbData.records > 0) {
                dbIndicator.innerHTML = `<i class="fas fa-database"></i><span>–ë–î: ${dbData.records} –∑–∞–ø–∏—Å–µ–π</span>`;
                dbIndicator.className = 'data-indicator real active';
            } else {
                dbIndicator.innerHTML = `<i class="fas fa-database"></i><span>–ë–î: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>`;
                dbIndicator.className = 'data-indicator api';
            }
        }
    } catch (error) {
        document.getElementById('dbIndicator').innerHTML = `<i class="fas fa-database"></i><span>–ë–î: –æ—à–∏–±–∫–∞</span>`;
        document.getElementById('dbIndicator').className = 'data-indicator demo';
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ API Felix Pila
    try {
        const apiResponse = await fetch('/api/felix-pila/predict');
        const apiIndicator = document.getElementById('apiIndicator');
        
        if (apiResponse.ok) {
            const apiData = await apiResponse.json();
            if (apiData.success && apiData.prediction) {
                apiIndicator.innerHTML = `<i class="fas fa-server"></i><span>API: —Ä–∞–±–æ—Ç–∞–µ—Ç</span>`;
                apiIndicator.className = 'data-indicator real active';
                dataSource = 'real';
            } else {
                apiIndicator.innerHTML = `<i class="fas fa-server"></i><span>API: –¥–µ–º–æ</span>`;
                apiIndicator.className = 'data-indicator api';
            }
        } else {
            apiIndicator.innerHTML = `<i class="fas fa-server"></i><span>API: –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</span>`;
            apiIndicator.className = 'data-indicator demo';
        }
    } catch (error) {
        document.getElementById('apiIndicator').innerHTML = `<i class="fas fa-server"></i><span>API: –æ—à–∏–±–∫–∞</span>`;
        document.getElementById('apiIndicator').className = 'data-indicator demo';
    }

    // –î–µ–º–æ-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω
    const demoIndicator = document.getElementById('demoIndicator');
    if (dataSource === 'demo') {
        demoIndicator.className = 'data-indicator demo active';
        demoIndicator.innerHTML = `<i class="fas fa-vial"></i><span>–î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ: –∞–∫—Ç–∏–≤–Ω—ã</span>`;
    } else {
        demoIndicator.className = 'data-indicator demo';
        demoIndicator.innerHTML = `<i class="fas fa-vial"></i><span>–î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ: –¥–æ—Å—Ç—É–ø–Ω—ã</span>`;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å –±–∞—Ä–∞
    updateStatusBar();
}

// 2. –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–° –ë–ê–†–ê
function updateStatusBar() {
    const dataSourceDot = document.getElementById('dataSourceDot');
    const dataSourceText = document.getElementById('dataSourceText');
    
    if (dataSource === 'real') {
        dataSourceDot.className = 'status-dot real';
        dataSourceText.textContent = '–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î –∏ API';
        dataSourceText.style.color = '#27ae60';
    } else if (dataSource === 'mixed') {
        dataSourceDot.className = 'status-dot demo';
        dataSourceText.textContent = '–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–º–µ—à–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ë–î + –¥–µ–º–æ)';
        dataSourceText.style.color = '#f39c12';
    } else {
        dataSourceDot.className = 'status-dot demo';
        dataSourceText.textContent = '–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
        dataSourceText.style.color = '#f39c12';
    }
}

// 3. –ü–†–û–ì–ù–û–ó FELIX PILA - –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø 8 –ß–ò–°–ï–õ
async function loadFelixPilaPrediction() {
    try {
        const response = await fetch('/api/felix-pila/predict');
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.success) {
                displayPrediction(data.prediction);
                document.getElementById('accuracyScore').textContent = 
                    Math.round((data.confidence || 0.65) * 100) + '%';
                dataSource = 'real';
                updateStatusBar();
                return;
            }
        }
        
        // –î–ï–ú–û-–î–ê–ù–ù–´–ï
        showDemoPrediction();
        dataSource = 'demo';
        updateStatusBar();
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞:', error);
        showDemoPrediction();
        dataSource = 'demo';
        updateStatusBar();
    }
}

function showDemoPrediction() {
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 8 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —á–∏—Å–µ–ª –¥–ª—è –¥–≤—É—Ö –ø–æ–ª–µ–π
    const allNumbers = [];
    while (allNumbers.length < 8) {
        const num = Math.floor(Math.random() * 20) + 1;
        if (!allNumbers.includes(num)) {
            allNumbers.push(num);
        }
    }
    
    const field1Numbers = allNumbers.slice(0, 4);
    const field2Numbers = allNumbers.slice(4, 8);
    
    displayPrediction({
        field_1: field1Numbers.map(num => ({
            number: num,
            probability: Math.round(Math.random() * 20 + 70)
        })),
        field_2: field2Numbers.map(num => ({
            number: num,
            probability: Math.round(Math.random() * 20 + 70)
        }))
    });
    
    document.getElementById('accuracyScore').textContent = '65%';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–æ—á–Ω–æ—Å—Ç–∏
    document.getElementById('accuracyText').textContent = '–¢–æ—á–Ω–æ—Å—Ç—å: 65% (–¥–µ–º–æ)';
    document.getElementById('accuracyDot').className = 'status-dot demo';
}

function displayPrediction(prediction) {
    const container = document.getElementById('weatherPrediction');
    container.innerHTML = '';
    
    // –ü–æ–ª—É—á–∞–µ–º —á–∏—Å–ª–∞ –¥–ª—è –ø–æ–ª–µ–π (–∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–µ–º–æ)
    const field1 = prediction.field_1 || prediction.recommended_numbers?.slice(0, 4) || generateFieldNumbers(4);
    const field2 = prediction.field_2 || prediction.recommended_numbers?.slice(4, 8) || generateFieldNumbers(4);
    
    // –ü–æ–ª–µ 1 (—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–µ)
    const field1Container = document.createElement('div');
    field1Container.className = 'field-container field-1';
    field1Container.innerHTML = `
        <div class="field-title">
            <i class="fas fa-star" style="color: #9b59b6;"></i>
            <span>–ü–æ–ª–µ 1</span>
        </div>
        <div class="field-numbers" id="field1Numbers"></div>
    `;
    
    // –ü–æ–ª–µ 2 (—Å–∏–Ω–µ–µ)
    const field2Container = document.createElement('div');
    field2Container.className = 'field-container field-2';
    field2Container.innerHTML = `
        <div class="field-title">
            <i class="fas fa-star" style="color: #3498db;"></i>
            <span>–ü–æ–ª–µ 2</span>
        </div>
        <div class="field-numbers" id="field2Numbers"></div>
    `;
    
    container.appendChild(field1Container);
    container.appendChild(field2Container);
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ 1
    const field1Numbers = document.getElementById('field1Numbers');
    field1.forEach((item, index) => {
        const numValue = typeof item === 'number' ? item : item.number;
        const numProb = item.probability || Math.round(Math.random() * 20 + 70);
        
        const numDiv = document.createElement('div');
        numDiv.className = 'felix-number-item';
        numDiv.innerHTML = `
            <div class="felix-number-rank">${index + 1}</div>
            <div class="felix-number-value">${numValue}</div>
            <div class="felix-number-prob">${numProb}%</div>
        `;
        field1Numbers.appendChild(numDiv);
    });
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ 2
    const field2Numbers = document.getElementById('field2Numbers');
    field2.forEach((item, index) => {
        const numValue = typeof item === 'number' ? item : item.number;
        const numProb = item.probability || Math.round(Math.random() * 20 + 70);
        
        const numDiv = document.createElement('div');
        numDiv.className = 'felix-number-item';
        numDiv.innerHTML = `
            <div class="felix-number-rank">${index + 1}</div>
            <div class="felix-number-value">${numValue}</div>
            <div class="felix-number-prob">${numProb}%</div>
        `;
        field2Numbers.appendChild(numDiv);
    });
}

function generateFieldNumbers(count) {
    const numbers = [];
    while (numbers.length < count) {
        const num = Math.floor(Math.random() * 20) + 1;
        if (!numbers.includes(num)) {
            numbers.push({
                number: num,
                probability: Math.round(Math.random() * 20 + 70)
            });
        }
    }
    return numbers;
}

// 4. –ò–ù–°–ê–ô–¢–´
async function loadInsights() {
    try {
        const response = await fetch('/api/felix-pila/analysis');
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.success) {
                displayInsights(data.analysis);
                return;
            }
        }
        
        // –î–ï–ú–û-–ò–ù–°–ê–ô–¢–´
        showDemoInsights();
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤—ã–≤–æ–¥–æ–≤:', error);
        showDemoInsights();
    }
}

function showDemoInsights() {
    document.getElementById('sunnyNumbers').innerHTML = renderNumbers([3, 7, 12, 16, 19]);
    document.getElementById('rainyNumbers').innerHTML = renderNumbers([2, 8, 11, 15, 20]);
    document.getElementById('lowPressureNumbers').innerHTML = renderNumbers([1, 5, 9, 13, 17]);
    document.getElementById('warmNumbers').innerHTML = renderNumbers([4, 6, 10, 14, 18]);
}

function renderNumbers(numbers) {
    return numbers.map(num => 
        `<div class="insight-number-badge">${num}</div>`
    ).join('');
}

// 5. –ê–ù–ê–õ–ò–ó –ò –ì–†–ê–§–ò–ö
async function loadAnalysis() {
    try {
        const response = await fetch('/api/felix-pila/analysis');
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.success) {
                showDemoChart();
                dataSource = 'real';
                updateStatusBar();
                return;
            }
        }
        
        showDemoChart();
        dataSource = 'demo';
        updateStatusBar();
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞:', error);
        showDemoChart();
        dataSource = 'demo';
        updateStatusBar();
    }
}

function showDemoChart() {
    const ctx = document.getElementById('analysisChart').getContext('2d');
    
    if (window.analysisChart) {
        window.analysisChart.destroy();
    }
    
    window.analysisChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['1-5', '6-10', '11-15', '16-20'],
            datasets: [{
                label: '–ß–∞—Å—Ç–æ—Ç–∞ –≤—ã–ø–∞–¥–µ–Ω–∏—è',
                data: [65, 59, 80, 71],
                backgroundColor: [
                    'rgba(155, 89, 182, 0.7)',  // —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
                    'rgba(52, 152, 219, 0.7)',  // —Å–∏–Ω–∏–π
                    'rgba(46, 204, 113, 0.7)',  // –∑–µ–ª–µ–Ω—ã–π
                    'rgba(243, 156, 18, 0.7)'   // –æ—Ä–∞–Ω–∂–µ–≤—ã–π
                ],
                borderColor: [
                    'rgb(155, 89, 182)',
                    'rgb(52, 152, 219)',
                    'rgb(46, 204, 113)',
                    'rgb(243, 156, 18)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            }
        }
    });
}

// 6. –û–ë–ù–û–í–õ–ï–ù–ò–ï –í–°–ï–• –î–ê–ù–ù–´–•
async function refreshAllData() {
    console.log("üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö...");
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById('accuracyText').textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
    document.getElementById('accuracyDot').className = 'status-dot demo';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏
    await checkDataSources();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥–Ω–æ–∑
    await loadFelixPilaPrediction();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Å–∞–π—Ç—ã
    await loadInsights();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–Ω–∞–ª–∏–∑
    await loadAnalysis();
    
    console.log("‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã");
}

// 7. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –í–°–ï–ì–û –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
document.addEventListener('DOMContentLoaded', async function() {
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    await checkDataSources();
    
    // –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    await loadFelixPilaPrediction();
    await loadInsights();
    await loadAnalysis();
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
    window.resetFelixFilters = function() {
        document.getElementById('weatherFilter').value = '';
        document.getElementById('tempFilter').value = '';
        loadAnalysis();
    };
    
    window.refreshAllData = refreshAllData;
});

// === –ö–û–ù–ï–¶ JavaScript –ö–û–î–ê ===
</script>
{% endblock %}