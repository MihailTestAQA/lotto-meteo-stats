{% extends "base.html" %}

{% block title %}–ü–æ–≥–æ–¥–∞ - LottoMeteoStats{% endblock %}

{% block content %}
<div class="weather-container">
    <h2><i class="fas fa-cloud-sun"></i> –ü–æ–≥–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
    
    <div class="weather-controls">
        <button onclick="loadWeather()" class="btn btn-primary">
            <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–≥–æ–¥—É
        </button>
        <div class="api-status">
            <span id="apiStatus">–°—Ç–∞—Ç—É—Å API: <i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
        </div>
    </div>
    
    <div id="weatherResult" class="weather-result">
        <div class="loading" id="loading">
            <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–≥–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...
        </div>
    </div>
    
    <div class="weather-info">
        <h3><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–≥–æ–¥–Ω–æ–º API</h3>
        <p>–î–ª—è —Ä–∞–±–æ—Ç—ã –ø–æ–≥–æ–¥–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è API –∫–ª—é—á –æ—Ç OpenWeatherMap:</p>
        <ol>
            <li>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è –Ω–∞ <a href="https://openweathermap.org/api" target="_blank">OpenWeatherMap</a></li>
            <li>–ü–æ–ª—É—á–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π API –∫–ª—é—á (1000 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å)</li>
            <li>–î–æ–±–∞–≤—å –∫–ª—é—á –≤ —Ñ–∞–π–ª <code>.env</code>: <code>WEATHER_API_KEY=—Ç–≤–æ–π_–∫–ª—é—á</code></li>
            <li>–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä</li>
        </ol>
        
        <div class="test-links">
            <h4>–¢–µ—Å—Ç–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏:</h4>
            <ul>
                <li><a href="/api/weather/current">/api/weather/current</a> - JSON API</li>
                <li><a href="/api/weather/test">/api/weather/test</a> - –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</li>
            </ul>
        </div>
    </div>
</div>

<style>
.weather-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
}

.weather-controls {
    display: flex;
    gap: 1rem;
    margin: 2rem 0;
    align-items: center;
    flex-wrap: wrap;
}

.api-status {
    padding: 0.5rem 1rem;
    background: #f8f9fa;
    border-radius: 4px;
    font-size: 0.9rem;
}

.weather-result {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    margin: 2rem 0;
    min-height: 200px;
}

.weather-card {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.weather-item {
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 6px;
}

.weather-item h4 {
    color: #666;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.weather-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2c3e50;
}

.loading {
    text-align: center;
    padding: 2rem;
    color: #666;
}

.weather-info {
    background: #e8f4fc;
    padding: 1.5rem;
    border-radius: 8px;
    margin-top: 2rem;
}

.test-links ul {
    list-style: none;
    padding-left: 0;
}

.test-links li {
    margin: 0.5rem 0;
}

.test-links a {
    color: #3498db;
    text-decoration: none;
}

.test-links a:hover {
    text-decoration: underline;
}

.error {
    color: #e74c3c;
    padding: 1rem;
    background: #fde8e8;
    border-radius: 4px;
    margin: 1rem 0;
}
</style>

<script>
// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ API
async function checkApiStatus() {
    try {
        const response = await fetch('/api/weather/current');
        const data = await response.json();
        
        const statusElement = document.getElementById('apiStatus');
        if (data.success) {
            statusElement.innerHTML = '–°—Ç–∞—Ç—É—Å API: <i class="fas fa-check-circle" style="color: #27ae60"></i> –†–∞–±–æ—Ç–∞–µ—Ç';
            loadWeather();
        } else {
            statusElement.innerHTML = `–°—Ç–∞—Ç—É—Å API: <i class="fas fa-exclamation-triangle" style="color: #e74c3c"></i> –û—à–∏–±–∫–∞: ${data.message}`;
        }
    } catch (error) {
        document.getElementById('apiStatus').innerHTML = 
            '–°—Ç–∞—Ç—É—Å API: <i class="fas fa-times-circle" style="color: #e74c3c"></i> –ù–µ –¥–æ—Å—Ç—É–ø–µ–Ω';
    }
}

async function loadWeather() {
    const loading = document.getElementById('loading');
    const result = document.getElementById('weatherResult');
    
    loading.style.display = 'block';
    result.innerHTML = '';
    
    try {
        const response = await fetch('/api/weather/current');
        const data = await response.json();
        
        if (data.success) {
            const weather = data.data;
           result.innerHTML = `
                <div class="weather-card">
                    <div class="weather-item">
                        <h4><i class="fas fa-city"></i> –ì–æ—Ä–æ–¥</h4>
                        <div class="weather-value">${weather.city}, ${weather.country}</div>
                    </div>
                    <div class="weather-item">
                        <h4><i class="fas fa-thermometer-half"></i> –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</h4>
                        <div class="weather-value">${weather.temperature}¬∞C</div>
                        <small>–û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ ${weather.feels_like}¬∞C</small>
                    </div>
                    <div class="weather-item">
                        <h4><i class="fas fa-cloud"></i> –ü–æ–≥–æ–¥–∞</h4>
                        <div class="weather-value">${weather.weather_description}</div>
                        <img src="https://openweathermap.org/img/wn/${weather.weather_icon}.png" alt="${weather.weather_main}">
                    </div>
                    <div class="weather-item">
                        <h4><i class="fas fa-tint"></i> –í–ª–∞–∂–Ω–æ—Å—Ç—å</h4>
                        <div class="weather-value">${weather.humidity}%</div>
                    </div>
                    <div class="weather-item">
                        <h4><i class="fas fa-tachometer-alt"></i> –î–∞–≤–ª–µ–Ω–∏–µ</h4>
                        <div class="weather-value">${weather.pressure_mmhg} –º–º —Ä—Ç.—Å—Ç.</div>
                        <small>(${weather.pressure_hpa} hPa)</small>
                    </div>
                    <div class="weather-item">
                        <h4><i class="fas fa-wind"></i> –í–µ—Ç–µ—Ä</h4>
                        <div class="weather-value">${weather.wind_speed} –º/—Å</div>
                    </div>
                    <div class="weather-item">
                        <h4><i class="fas fa-sun"></i> –í–æ—Å—Ö–æ–¥/–ó–∞–∫–∞—Ç</h4>
                        <div style="font-size: 0.9rem;">
                            üåÖ ${new Date(weather.sunrise).toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}<br>
                            üåá ${new Date(weather.sunset).toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}
                        </div>
                    </div>
                </div>
                <div style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
                    <i class="far fa-clock"></i> –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(weather.timestamp).toLocaleString('ru-RU')}
                </div>
            `;
        } else {
            result.innerHTML = `
                <div class="error">
                    <h4><i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã</h4>
                    <p>${data.message}</p>
                    <p>–ü—Ä–æ–≤–µ—Ä—å API –∫–ª—é—á –≤ —Ñ–∞–π–ª–µ .env</p>
                </div>
            `;
        }
    } catch (error) {
        result.innerHTML = `
            <div class="error">
                <h4><i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h4>
                <p>${error.message}</p>
            </div>
        `;
    } finally {
        loading.style.display = 'none';
    }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', checkApiStatus);
</script>
{% endblock %}